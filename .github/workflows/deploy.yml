name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., latest, v1.0.0)'
        required: true
        default: 'latest'
      skip_health_check:
        description: 'Skip health check (not recommended)'
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ghcr.io/open-syntax/ultimatexo
  DEPLOY_USER: ${{ secrets.PROD_USERNAME }}
  DEPLOY_HOST: ${{ secrets.PROD_HOST }}

jobs:
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    environment: production
    outputs:
      version: ${{ github.event.inputs.version }}
    steps:
      - name: Validate inputs
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ” Validating version: $VERSION"

          if [[ -z "$VERSION" ]]; then
            echo "âŒ Version cannot be empty"
            exit 1
          fi

          echo "âœ… Version validated: $VERSION"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify images exist
        run: |
          VERSION="${{ github.event.inputs.version }}"

          for component in client server caddy; do
            IMAGE="${{ env.IMAGE_BASE }}-${component}:${VERSION}"
            echo "Checking: $IMAGE"

            if ! docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
              echo "âŒ Image not found: $IMAGE"
              exit 1
            fi
            echo "âœ… Found: $IMAGE"
          done

      - name: Notify start
        uses: sarisia/actions-status-discord@v1
        continue-on-error: true
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸš€ Deployment Starting"
          description: |
            **Version:** `${{ github.event.inputs.version }}`
            **Initiated by:** ${{ github.actor }}
            **Environment:** Production
            **URL:** https://ultimatexo.com
          color: 0xffc107
          username: "UltimateXO Deploy"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://ultimatexo.com
    steps:
      - uses: actions/checkout@v6

      - name: Prepare deployment
        run: |
          mkdir -p deploy
          cp docker-compose.yml deploy/

          cat > deploy/.env << EOF
          IMAGE_BASE=${{ env.IMAGE_BASE }}
          VERSION=${{ github.event.inputs.version }}
          CLOUDFLARE_EMAIL=${{ secrets.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}
          RUST_LOG=info
          EOF

          cat > deploy/deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -euo pipefail

          VERSION="${1:-latest}"
          SKIP_HEALTH="${2:-false}"

          cd ~/ultimatexo

          echo "ðŸ“¦ Backup current state..."
          BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"

          if [ -f .env ]; then
            cp .env "$BACKUP_DIR/.env"
            CURRENT_VERSION=$(grep "^VERSION=" .env | cut -d= -f2 || echo "unknown")
            echo "$CURRENT_VERSION" > "$BACKUP_DIR/version.txt"
            echo "Previous version: $CURRENT_VERSION"
          fi

          docker compose ps -a > "$BACKUP_DIR/containers.txt" 2>/dev/null || true

          echo "ðŸ” Login to registry..."
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

          echo "ðŸ“¥ Pull images for version: $VERSION"
          docker compose pull

          echo "ðŸ§¹ Remove client-builder if exists..."
          docker compose rm -f client-builder 2>/dev/null || true

          echo "ðŸš€ Deploy services..."
          docker compose up -d --remove-orphans

          if [ "$SKIP_HEALTH" = "false" ]; then
            echo "â³ Health check (max 5 minutes)..."

            for i in {1..30}; do
              echo "Attempt $i/30..."

              if docker inspect ultimatexo-server --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
                echo "âœ… Server healthy"

                if curl -sf http://localhost > /dev/null 2>&1 || \
                   curl -sf http://localhost -o /dev/null -w "%{http_code}" | grep -qE "^(200|308|301)$"; then
                  echo "âœ… Proxy responding"
                  echo "âœ… Deployment successful!"

                  echo "ðŸ§¹ Cleanup old images..."
                  docker image prune -af --filter "until=168h" || true

                  exit 0
                fi
              fi

              sleep 10
            done

            echo "âŒ Health check timeout"
            echo "ðŸ“‹ Service logs:"
            docker compose logs --tail=50
            exit 1
          fi

          echo "âš ï¸ Health check skipped"
          echo "âœ… Services started"
          SCRIPT

          chmod +x deploy/deploy.sh

      - name: Copy files to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "deploy/*"
          target: "~/ultimatexo/"
          strip_components: 1
          overwrite: true

      - name: Execute deployment
        uses: appleboy/ssh-action@v1.2.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: GITHUB_TOKEN,GITHUB_ACTOR
          command_timeout: 10m
          script: |
            cd ~/ultimatexo
            ./deploy.sh "${{ github.event.inputs.version }}" "${{ github.event.inputs.skip_health_check }}"

  verify:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.skip_health_check != 'true'
    steps:
      - name: Wait for stabilization
        run: |
          echo "â³ Waiting 30s for deployment to stabilize..."
          sleep 30

      - name: Health checks
        run: |
          MAX_ATTEMPTS=5
          DELAY=10

          check_endpoint() {
            local url=$1
            local name=$2

            for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "[$i/$MAX_ATTEMPTS] Checking $name..."

              if curl -fsSL "$url" > /dev/null 2>&1; then
                echo "âœ… $name OK"
                return 0
              fi

              [ $i -lt $MAX_ATTEMPTS ] && sleep $DELAY
            done

            echo "âŒ $name failed"
            return 1
          }

          FAILED=0
          check_endpoint "https://ultimatexo.com" "Homepage" || FAILED=1
          check_endpoint "https://ultimatexo.com/api/health" "API Health" || FAILED=1

          if [ $FAILED -eq 1 ]; then
            echo "âŒ Verification failed"
            exit 1
          fi

          echo "âœ… All checks passed"

      - name: Performance check
        run: |
          echo "ðŸ“Š Performance baseline..."

          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' https://ultimatexo.com)
          echo "Response time: ${RESPONSE_TIME}s"

          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "âš ï¸ Response time above 2s"
          else
            echo "âœ… Response time acceptable"
          fi

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate, deploy, verify]
    if: always()
    steps:
      - name: Success notification
        if: needs.deploy.result == 'success' && (needs.verify.result == 'success' || needs.verify.result == 'skipped')
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âœ… Deployment Successful"
          description: |
            ðŸŽ‰ **UltimateXO ${{ needs.validate.outputs.version }}** is live!

            **Environment:** Production
            **URL:** https://ultimatexo.com
            **Deployed by:** ${{ github.actor }}
            **Health Check:** ${{ needs.verify.result == 'skipped' && 'â­ï¸ Skipped' || 'âœ… Passed' }}
          color: 0x28a745
          username: "UltimateXO Deploy"

      - name: Failure notification
        if: needs.deploy.result == 'failure' || needs.verify.result == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ Deployment Failed"
          description: |
            ðŸš¨ **Deployment of ${{ needs.validate.outputs.version }} failed!**

            **Failed at:** ${{ needs.deploy.result == 'failure' && 'Deployment' || 'Verification' }}
            **Logs:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ðŸ’¡ **To rollback:** Re-run workflow with previous version
          color: 0xdc3545
          username: "UltimateXO Deploy"

      - name: Deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Summary

          **Version:** `${{ needs.validate.outputs.version }}`
          **Status:** ${{ needs.deploy.result == 'success' && needs.verify.result != 'failure' && 'âœ… Success' || 'âŒ Failed' }}

          | Stage | Status |
          |-------|--------|
          | Validation | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} |
          | Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || 'âŒ' }} |
          | Verify | ${{ needs.verify.result == 'success' && 'âœ…' || needs.verify.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |

          ---

          **ðŸ”„ To rollback:** Manually trigger this workflow with a previous version
          EOF
