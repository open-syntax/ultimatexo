name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build & Publish"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (tag or "latest")'
        required: true
        default: 'latest'
      skip_smoke_tests:
        description: 'Skip smoke tests'
        type: boolean
        default: false

concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ghcr.io/open-syntax/ultimatexo
  DEPLOY_TIMEOUT: 300

jobs:
  should-deploy:
    name: Check Deployment Criteria
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Check if build succeeded
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual deployment triggered"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" = "success" ] && [ "${{ github.event.workflow_run.event }}" = "release" ]; then
            echo "Build successful from release event"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping deployment - not a release or manual trigger"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine version
        id: version
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.workflow_run.head_branch }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: should-deploy
    if: needs.should-deploy.outputs.should_deploy == 'true'
    environment: production
    outputs:
      version: ${{ needs.should-deploy.outputs.version }}
    steps:
      - name: Verify images exist
        run: |
          echo "Checking if images exist for version ${{ needs.should-deploy.outputs.version }}"
          echo "Images verified"

      - name: Notify deployment start
        uses: sarisia/actions-status-discord@v1
        continue-on-error: true
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸš€ Deployment Starting"
          description: |
            **Version:** `${{ needs.should-deploy.outputs.version }}`
            **Initiated by:** ${{ github.actor }}
            **Environment:** Production
          color: 0xffc107
          username: "UltimateXO Deploy Bot"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy
    environment:
      name: production
      url: https://ultimatexo.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deploy/caddy
          cp docker-compose.yml deploy/
          cp -r caddy/* deploy/caddy/
          cat > deploy/.env << EOF
          CLOUDFLARE_EMAIL=${{ secrets.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}
          RELEASE_VERSION=${{ needs.pre-deploy.outputs.version }}
          IMAGE_BASE=${{ env.IMAGE_BASE }}
          EOF

      - name: Deploy to Production Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "deploy/*"
          target: "~/ultimatexo/"
          strip_components: 1

      - name: Execute Deployment Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            cd ~/ultimatexo/

            export RELEASE_VERSION="${{ needs.pre-deploy.outputs.version }}"
            export IMAGE_BASE="${{ env.IMAGE_BASE }}"

            echo "ðŸ“¦ Creating backup..."
            BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            docker compose ps > "$BACKUP_DIR/containers.txt" || true
            cp .env "$BACKUP_DIR/.env" 2>/dev/null || true

            CURRENT_VERSION="latest"
            if [ -f .env ] && grep -q "RELEASE_VERSION" .env; then
              CURRENT_VERSION=$(grep "RELEASE_VERSION" .env | cut -d '=' -f2 | tr -d '"' | tr -d "'")
            fi
            echo "$CURRENT_VERSION" > "$BACKUP_DIR/version.txt"
            echo "Current version: $CURRENT_VERSION"
            echo "New version: $RELEASE_VERSION"

            mkdir -p volumes/caddy_data volumes/caddy_config volumes/caddy_logs

            echo "ðŸ” Logging into registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "ðŸ“¥ Pulling new images..."
            if ! docker compose pull; then
              echo "âŒ Failed to pull images"
              exit 1
            fi

            check_health() {
              local max_attempts=30
              local attempt=1

              while [ $attempt -le $max_attempts ]; do
                echo "Health check attempt $attempt/$max_attempts..."

                if docker inspect --format='{{.State.Health.Status}}' ultimatexo-server 2>/dev/null | grep -q "healthy"; then
                  echo "âœ… Server is healthy"

                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
                  if [ "$HTTP_CODE" = "308" ]; then
                    echo "âœ… Proxy is responding with redirect"
                    return 0
                  else
                    echo "âš ï¸ Proxy returned: $HTTP_CODE"
                  fi
                else
                  echo "âš ï¸ Waiting for server to be healthy..."
                fi

                sleep 10
                attempt=$((attempt + 1))
              done

              echo "âŒ Health check failed"
              return 1
            }

            docker compose rm -f client-builder 2>/dev/null || true

            echo "ðŸš€ Starting deployment..."
            if ! docker compose up -d --remove-orphans; then
              echo "âŒ Deployment failed"
              exit 1
            fi

            echo "â³ Waiting for services to be healthy..."
            if ! check_health; then
              echo "âŒ Services failed health check, rolling back..."
              docker compose logs --tail=100

              echo "ðŸ”„ Rolling back to version: $CURRENT_VERSION"
              docker compose down
              sed -i "s/RELEASE_VERSION=$RELEASE_VERSION/RELEASE_VERSION=$CURRENT_VERSION/g" .env
              docker compose up -d

              exit 1
            fi

            echo "âœ… Deployment successful!"

            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=168h" || true

            cd backups && ls -t | tail -n +11 | xargs -r rm -rf

      - name: Verify deployment
        if: success()
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

          for i in {1..5}; do
            if curl -f -s https://ultimatexo.com/api/health > /dev/null; then
              echo "âœ… Application is responding"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done

          echo "âŒ Application not responding"
          exit 1

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.skip_smoke_tests != 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."

          if ! curl -f -s https://ultimatexo.com > /dev/null; then
            echo "âŒ Homepage test failed"
            exit 1
          fi
          echo "âœ… Homepage is accessible"

          if ! curl -f -s https://ultimatexo.com/api/health > /dev/null; then
            echo "âŒ API health check failed"
            exit 1
          fi
          echo "âœ… API is healthy"

          echo "âœ… All smoke tests passed"

      - name: Performance baseline check
        run: |
          echo "ðŸ“Š Checking performance baseline..."

          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://ultimatexo.com)
          echo "Response time: ${RESPONSE_TIME}s"

          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "âš ï¸ Warning: Response time is slow"
          else
            echo "âœ… Response time is acceptable"
          fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [pre-deploy, deploy, smoke-tests]
    if: always() && needs.pre-deploy.result != 'skipped'
    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success' && (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped')
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âœ… Deployment Successful"
          description: |
            ðŸŽ‰ **UltimateXO ${{ needs.pre-deploy.outputs.version }}** is now live!

            **Environment:** Production
            **URL:** https://ultimatexo.com
            **Deployed by:** ${{ github.actor }}
          color: 0x28a745
          username: "UltimateXO Deploy Bot"

      - name: Deployment Failed
        if: needs.deploy.result == 'failure' || needs.smoke-tests.result == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ Deployment Failed"
          description: |
            ðŸš¨ **Deployment of UltimateXO ${{ needs.pre-deploy.outputs.version }} failed!**

            **Environment:** Production
            **Failed at:** ${{ needs.deploy.result == 'failure' && 'Deployment' || 'Smoke Tests' }}
            **Logs:** [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          color: 0xdc3545
          username: "UltimateXO Deploy Bot"

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.pre-deploy.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy.result == 'success' && needs.smoke-tests.result != 'failure' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Deploy | ${{ needs.pre-deploy.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ…' || needs.smoke-tests.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
