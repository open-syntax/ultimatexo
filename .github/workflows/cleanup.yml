name: Cleanup & Maintenance

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  cleanup-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete old container images
        uses: snok/container-retention-policy@v2
        with:
          image-names: ultimatexo-client,ultimatexo-server
          cut-off: 30 days ago UTC
          account-type: org
          org-name: open-syntax
          keep-at-least: 5
          untagged-only: true
          token: ${{ secrets.GITHUB_TOKEN }}

  cleanup-caches:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup old caches
        run: |
          echo "üßπ Cleaning up old GitHub Actions caches..."
          gh extension install actions/gh-actions-cache || true
          
          # Keep caches from main branch and last 7 days
          gh actions-cache list --limit 100 | \
            grep -v "refs/heads/main" | \
            awk '{print $1}' | \
            xargs -I {} gh actions-cache delete {} --confirm || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-workflow-runs:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 90
          keep_minimum_runs: 10

  report:
    name: Maintenance Report
    runs-on: ubuntu-latest
    needs: [cleanup-images, cleanup-caches, cleanup-workflow-runs]
    if: always()
    steps:
      - name: Send report
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üßπ Maintenance Complete"
          description: |
            **Cleanup Tasks:**
            ‚Ä¢ Images: ${{ needs.cleanup-images.result == 'success' && '‚úÖ' || '‚ùå' }}
            ‚Ä¢ Caches: ${{ needs.cleanup-caches.result == 'success' && '‚úÖ' || '‚ùå' }}
            ‚Ä¢ Workflow Runs: ${{ needs.cleanup-workflow-runs.result == 'success' && '‚úÖ' || '‚ùå' }}
            
            [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          color: 0x0366d6
          username: "UltimateXO Maintenance Bot"
